# Append Work Items Section - Tree Format
if ($filteredWorkItems.Count -gt 0) {
    Write-Host "`nğŸ“‚ Building hierarchical work item tree..."

    # Create a dictionary of all work items by ID
    $allWorkItems = @{}
    foreach ($item in $filteredWorkItems) {
        $allWorkItems[$item.id] = $item
    }

    # Recursively fetch all parents
    $expandedIds = @{}
    foreach ($item in $filteredWorkItems) {
        $current = $item
        while ($current.fields.'System.Parent') {
            $parentId = $current.fields.'System.Parent'
            if (-not $allWorkItems.ContainsKey($parentId)) {
                try {
                    $parentItem = Invoke-RestMethod `
                        -Uri "$orgUrl/_apis/wit/workitems/$parentId?api-version=$WIT_API_VERSION" `
                        -Headers $authHeader
                    $allWorkItems[$parentId] = $parentItem
                    $current = $parentItem
                } catch {
                    Write-Host "âš ï¸ Failed to fetch parent item $parentId: $_"
                    break
                }
            } else {
                $current = $allWorkItems[$parentId]
            }
        }
    }

    # Build reverse lookup: parent â†’ children
    $tree = @{}
    foreach ($item in $allWorkItems.Values) {
        $id = $item.id
        $parentId = $item.fields.'System.Parent'
        if ($parentId) {
            if (-not $tree.ContainsKey($parentId)) {
                $tree[$parentId] = @()
            }
            $tree[$parentId] += $item
        }
    }

    # Identify root items (no parent in the collected set)
    $rootItems = $allWorkItems.Values | Where-Object { -not $_.fields.'System.Parent' }

    function Format-WorkItemTree {
        param (
            [Parameter(Mandatory = $true)][object]$workItem,
            [Parameter(Mandatory = $true)][ref]$content,
            [int]$level = 0
        )

        $indent = '  ' * $level
        $emojiMap = @{
            'Epic'    = 'ğŸ“¦'
            'Feature' = 'ğŸŒŸ'
            'Product Backlog Item' = 'ğŸ“Œ'
            'Bug'     = 'ğŸ'
            'Task'    = 'ğŸ”§'
        }
        $type = $workItem.fields.'System.WorkItemType'
        $icon = $emojiMap[$type] ?? 'ğŸ”¹'

        $content.Value += "$indent- $icon **$type #$($workItem.id)**: [$($workItem.fields.'System.Title')]($orgUrl/$PROJECT_NAME/_workitems/edit/$($workItem.id))`n"

        if ($tree.ContainsKey($workItem.id)) {
            foreach ($child in $tree[$workItem.id] | Sort-Object -Property id) {
                Format-WorkItemTree -workItem $child -content $content -level ($level + 1)
            }
        }
    }

    # Add section header
    $mdContent += "`n## ğŸ“Œ **Work Items (Hierarchical)**`n"

    foreach ($root in $rootItems | Sort-Object -Property id) {
        Format-WorkItemTree -workItem $root -content ([ref]$mdContent)
    }

} else {
    $mdContent += "`n## ğŸ“Œ **Work Items**`n"
    $mdContent += "_No work items completed in this release._`n"
}
