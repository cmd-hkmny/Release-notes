# Get Work Item Details
        function Get-WorkItemDetails {
            param($id)
            if (-not $id) {
                Write-Warning "Skipped work item with null ID"
                return $null
            }
            $uri = "$orgUrl/$PROJECT_NAME/_apis/wit/workitems/${id}?`$expand=relations&api-version=$WIT_API_VERSION"
            try {
                $result = Invoke-RestMethod -Uri $uri -Headers $authHeader -ErrorAction SilentlyContinue
                if ($result) {
                    return [PSCustomObject]@{
                        Id = $result.id
                        Title = $result.fields.'System.Title'
                        Type = $result.fields.'System.WorkItemType'
                        Url = "$orgUrl/$PROJECT_NAME/_workitems/edit/$($result.id)"
                        Relations = $result.relations
                    }
                }
            } catch {
                Write-Warning "Failed to fetch work item ${id}: $_"
            }
            return $null
        }
        # Collect work items
        $allWorkItems = @{}
        $childWorkItems = @()
        $workItemsInPRs = @()

        foreach ($pr in $filteredPRs) {
            $workItems = Invoke-RestMethod -Uri "$orgUrl/$PROJECT_NAME/_apis/git/repositories/$REPO_NAME/pullRequests/$($pr.pullRequestId)/workitems?api-version=$GIT_API_VERSION" -Headers $authHeader
            foreach ($item in $workItems.value) {
                $wi = Get-WorkItemDetails -id $item.id
                if ($wi -and $wi.Type -in @('Product Backlog Item', 'Bug', 'Feature', 'Task', 'Issue', 'User Story', 'Epic')) {
                    if (-not $allWorkItems.ContainsKey($wi.Id)) {
                        $allWorkItems[$wi.Id] = $wi
                        $childWorkItems += $wi
                    }
                    $workItemsInPRs += $wi.Id
                }
            }
        }

        # Build hierarchy without duplicates but ensure all work items are shown
        $hierarchyMap = @{}
        $processedItems = @{}
        $flatWorkItems = @{}

        function Get-FullHierarchy {
            param($item)
            $hierarchy = @()
            $current = $item
            
            # Walk up the hierarchy
            while ($current) {
                $hierarchy += $current
                $parentRel = $current.Relations | Where-Object { $_.rel -eq "System.LinkTypes.Hierarchy-Reverse" } | Select-Object -First 1
                if (-not $parentRel) { break }
                
                $parentId = $parentRel.url -split '/' | Select-Object -Last 1
                if (-not $allWorkItems.ContainsKey($parentId)) {
                    $parent = Get-WorkItemDetails -id $parentId
                    if ($parent) {
                        $allWorkItems[$parentId] = $parent
                    } else {
                        break
                    }
                }
                $current = $allWorkItems[$parentId]
            }
            
            [Array]::Reverse($hierarchy)
            return $hierarchy
        }

        # First show all work items in a flat list
        $mdContent = "# Release Notes for $REPO_NAME`n`n"
        $mdContent += "**Release Range**: $previousTag to $latestTag`n"
        $mdContent += "**Date**: $(Get-Date -Format 'yyyy-MM-dd')`n"
        $mdContent += "**Commits Included**: $commitCount`n"
        $mdContent += "**Pull Requests Merged**: $prCount`n"
        $mdContent += "**Work Items Completed**: $($childWorkItems.Count)`n`n"

        if ($childWorkItems.Count -gt 0) {
            $mdContent += "## All Work Items`n"
            foreach ($item in $childWorkItems | Sort-Object -Property Type, Id) {
                $mdContent += "* **$($item.Type) #$($item.Id)**: [$($item.Title)]($($item.Url))`n"
            }
            $mdContent += "`n"
            
            # Then show hierarchy view
            $mdContent += "## Work Items Hierarchy`n"
            
            $completeHierarchies = @()
            foreach ($item in $childWorkItems) {
                $hierarchy = Get-FullHierarchy -item $item
                $completeHierarchies += ,$hierarchy
            }

            $processedItems = @{}
            $currentEpic = $null
            
            foreach ($hierarchy in $completeHierarchies) {
                $epic = $hierarchy | Where-Object { $_.Type -eq "Epic" } | Select-Object -First 1
                
                # Add spacing between different epics
                if ($currentEpic -and $currentEpic.Id -ne $epic.Id) {
                    $mdContent += "`n"
                }
                $currentEpic = $epic
                
                for ($i = 0; $i -lt $hierarchy.Count; $i++) {
                    $item = $hierarchy[$i]
                    if (-not $processedItems.ContainsKey($item.Id)) {
                        $indent = "    " * $i
                        $icon = switch ($item.Type) {
                            "Epic" { "üè∞" }
                            "Feature" { "üß©" }
                            default { "üîß" }
                        }
                        
                        $mdContent += "$indent* $icon **$($item.Type) #$($item.Id)**: [$($item.Title)]($($item.Url))`n"
                        $processedItems[$item.Id] = $true
                    }
                }
            }
        }
        if ($prCount -gt 0) {
            $mdContent += "## Pull Requests`n"
            $mdContent += ($filteredPRs | Sort-Object -Property pullRequestId | ForEach-Object {
                $prDate = [datetime]::Parse($_.creationDate)
                "* **PR #$($_.pullRequestId)**: [$($_.title)]($orgUrl/$PROJECT_NAME/_git/$REPO_NAME/pullrequest/$($_.pullRequestId)) (Created by $($_.createdBy.displayName) on $($prDate.ToString('yyyy-MM-dd')))"
            }) -join "`n"
            $mdContent += "`n`n"
        }

        $mdContent += "[[_Back to Releases|Home]]`n"

        $artifactFilePath = "$ARTIFACT_DIR/$REPO_NAME-$latestTag.md"
        $mdContent | Out-File -FilePath $artifactFilePath -Encoding utf8

        Write-Host "##vso[task.setvariable variable=RELEASE_NOTES_CONTENT]$mdContent"
        Write-Host "##vso[task.setvariable variable=RELEASE_NOTES_FILE]$artifactFilePath"
        Write-Host "##vso[task.setvariable variable=RELEASE_NOTES_PATH]$WIKI_FOLDER/$REPO_NAME-$latestTag"
